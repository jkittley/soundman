{% extends 'frontend/base.html' %}
{% load static %}

{% block style %}
{% endblock %}



{% block content %} 
<div class="container-fluid">
    Node: <span id="node_name"></span>
    <div class="row">
        <div id="plot-space" class="col-md-12 col-lg-7 col-xl-8"></div>
        <div class="col-md-12 col-lg-5 col-xl-4">
            <ul id="data-list" class="list-group"></ul>
        </div>
    </div>

    <div class="row justify-content-center">
        <div id="signal-row" class="col border p-4 m-4 text-center"><h1 class="display-1"></h1></div>    
        <div id="volume-row" class="col border p-4 m-4 text-center"><h1 class="display-1"></h1></div>
        <div class="col border p-4 m-4 text-center">
            <h2 id="timestamp" class="display-4"></h2>
            <br><br>
            <a id="btn-update" class="btn btn-xl btn-info"><i class="fas fa-sync"></i> Refresh</a>
        </div>
    </div>

    <div id="options-bar" class="row mb-4 ">
        <div class="col-12">
            <a href="/" class="btn btn-info btn-block">Back</a>
        </div>
    </div>
</div>
{% endblock %}     

{% block endscript %}   
    <script>
        
        var hide_signal = {{ hide_signal|yesno:"true,false" }};
        var hide_volume = {{ hide_volume|yesno:"true,false" }};
        var pick_selected = {{ request.session.pick_selected|safe}};
        var reading_expected_every_seconds = 60;
        var sid = 0;
        for (var k in pick_selected) {
            sid = parseInt(k);
            break
        }

        // Plot
        var app = {
            num_signal_bars: 10,
            num_volume_bars: 10,
            min_db: 35, // Background level
            max_db: 90, // Everything above this is 100%
            worst_sig: Math.abs(-90),
            best_sig: Math.abs(-25), 
        }
        
              
        // Takes a percentage
        var setMeters = function(ts, vol, sig) {
            console.log("setting meters", vol, sig);
                
            var signalBars = Math.round(app.num_signal_bars * (sig / 100));
            console.log('signalBars', signalBars);

            var volumeBars = Math.round(app.num_volume_bars * (vol / 100));
            console.log('volumeBars', volumeBars);

            $('#signal-row h1').html(signalBars + "%");
            $('#volume-row h1').html(volumeBars + "%");

            $('#timestamp').html(ts.format("YYYY-MM-DD<BR>HH:mm:ss"));

        }
                
        var wifiConnectionToServerFailed = function(e) {
            
        }

        // Run
        var fetchBoy = function() {

            getSensors(function (sensor, error) {
               if (error) { wifiConnectionToServerFailed(error); return; }

               if(sensor.id === sid) {
                // console.log(sensor);
                $('#node_name').html(sensor.mac);

                // Get readings
                var s = moment.utc().subtract(reading_expected_every_seconds * 10, 's'); // Get readings
                var e = moment.utc();
                
                getReadings(sensor, s, e, function(readings, error) {
                    
                    if (error) { wifiConnectionToServerFailed(error); return; }
                    
                    if (readings.length > 0) {

                        var reading = readings[0];
                        for (i in readings) {
                            if (moment.utc(readings[i].ts).isAfter(moment.utc(reading.ts))) reading = readings[i];
                        }
                        
                        // var reading = readings[readings.length-1];
                        console.log(reading);

                        var vol = reading.volume;
                        var sig = reading.RSSI;
                        var ts = moment.utc(reading.ts);                      

                        vol = Math.max(0, Math.min(100, 100 * ( (vol-app.min_db) / (app.max_db-app.min_db) ) ));
                        sig = 100 - Math.max(0, Math.min(100, 100 * ( (Math.abs(sig) - app.best_sig) / (app.worst_sig-app.best_sig) ) ));
                        setMeters(ts, vol, sig, "black");
                        
                    }
                });
               }
         });
        }   

        fetchBoy();        
        $('#btn-update').click(fetchBoy);

    </script>
{% endblock %}
